<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CaptionFlow</title>
  <style>
    body {
      background-color: #121212;
      color: #f0f0f0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    h1 { color: #00ffc3; }
    .caption-box, .last-caption {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
      margin: 10px;
      width: 80%;
      max-width: 600px;
      font-size: 1.2em;
      text-align: center;
    }
    button {
      background-color: #00ffc3;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-size: 1em;
      margin-top: 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #00cc9d;
    }
  </style>
</head>
<body>
  <h1>🎤 CaptionFlow</h1>
  <div class="caption-box" id="caption">Press record and speak...</div>
  <div class="last-caption" id="lastCaption">Last caption will appear here.</div>
  <button id="recordBtn">🎙 Start Recording</button>

  <script>
    const API_KEY = "AIzaSyB7Hg1BRNApZKKvFode_gqu-4wSoNDrdb0"; // <== Paste your key here
    let mediaRecorder;
    let chunks = [];
    let isRecording = false;

    const captionDiv = document.getElementById("caption");
    const lastCaptionDiv = document.getElementById("lastCaption");
    const recordBtn = document.getElementById("recordBtn");

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

      chunks = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
          chunks.push(e.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/webm" });
        const base64Audio = await blobToBase64(blob);
        captionDiv.innerText = "Processing...";

        const response = await fetch(
          `https://speech.googleapis.com/v1/speech:recognize?key=${API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              config: {
                encoding: "WEBM_OPUS",
                sampleRateHertz: 48000,
                languageCode: "en-US"
              },
              audio: { content: base64Audio.split(",")[1] }
            })
          }
        );

        const data = await response.json();
        if (data.results && data.results[0]) {
          const transcript = data.results.map(r => r.alternatives[0].transcript).join("\n");
          lastCaptionDiv.innerText = "Last Caption: " + transcript;
          captionDiv.innerText = "Final Caption: " + transcript;
        } else {
          captionDiv.innerText = "No speech detected.";
        }
      };

      mediaRecorder.start();
      isRecording = true;
      recordBtn.innerText = "⏹ Stop Recording";
      captionDiv.innerText = "Listening...";
    }

    function stopRecording() {
      mediaRecorder.stop();
      isRecording = false;
      recordBtn.innerText = "🎙 Start Recording";
    }

    recordBtn.onclick = () => {
      if (!isRecording) {
        startRecording();
      } else {
        stopRecording();
      }
    };

    function blobToBase64(blob) {
      return new Promise((resolve, _) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
